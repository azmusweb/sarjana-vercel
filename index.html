<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Memuat...</title>
  <meta name="description" content=""/>
  <link rel="stylesheet" href="style.css"/>
  <style>
    body { font-family: sans-serif; margin: 0; }
    header, nav, footer { background: #004d40; color: white; padding: 10px; }
    nav ul { display: flex; flex-wrap: wrap; gap: 10px; list-style: none; padding: 0; margin: 0; }
    nav li { position: relative; }
    nav li ul { display: none; position: absolute; background: #00695c; padding: 10px; list-style: none; top: 100%; left: 0; }
    nav li:hover ul { display: block; }
    .container { display: flex; flex-direction: row; padding: 20px; gap: 20px; }
    .content { flex: 3; }
    .sidebar { flex: 1; position: sticky; top: 20px; background: #f1f1f1; padding: 10px; }
    .post { margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
    footer { text-align: center; }
  </style>
</head>
<body>

<header>
  <h1 id="site-title">Sarjana</h1>
</header>

<nav>
  <ul id="menu"></ul>
</nav>

<div class="container">
  <aside class="sidebar" id="left-sidebar">Memuat sidebar kiri...</aside>

  <main class="content" id="news-content">
    Memuat berita...
  </main>

  <aside class="sidebar" id="right-sidebar">Memuat sidebar kanan...</aside>
</div>

<footer id="footer">
  Memuat footer...
</footer>

<script>
const spreadsheetId = '1oMHeKOF2_D6deuV8T1l10_GB0wgsPGLV7WrPcJ6Qxww';
const apiKey = 'AIzaSyDKOClQy1z23Hwjr9HyHmzJbuaPE9Ccbv4';
const base = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values`;

async function fetchSheet(range) {
  const url = `${base}/${range}?alt=json&key=${apiKey}`;
  const res = await fetch(url);
  const data = await res.json();
  return data.values || [];
}

// Load config
async function loadConfig() {
  const rows = await fetchSheet('Config');
  const config = {};
  rows.forEach(([fungsi, isi]) => {
    config[fungsi.trim().toLowerCase()] = isi;
  });
  document.title = config['seo-title'] || 'Sarjana';
  document.querySelector('meta[name=description]').setAttribute('content', config['seo-deskripsi'] || '');
  document.getElementById('footer').innerHTML = config['footer'] || '';
  document.getElementById('site-title').textContent = config['judul-website'] || 'Sarjana';
}

// Load menu
async function loadMenu() {
  const raw = await fetchSheet('Config');
  const nav = raw.filter(r => r[0].toLowerCase().startsWith('menu'));
  const menuContainer = document.getElementById('menu');
  menuContainer.innerHTML = '';
  nav.forEach(([_, html]) => {
    const li = document.createElement('li');
    li.innerHTML = html;
    menuContainer.appendChild(li);
  });
}

// Load sidebars
async function loadSidebars() {
  const rows = await fetchSheet('Config');
  const left = rows.find(r => r[0].toLowerCase() === 'sidebar-kiri');
  const right = rows.find(r => r[0].toLowerCase() === 'sidebar-kanan');
  if (left) document.getElementById('left-sidebar').innerHTML = left[1];
  if (right) document.getElementById('right-sidebar').innerHTML = right[1];
}

// Load news
async function loadNews() {
  const rows = await fetchSheet('Live Website');
  const container = document.getElementById('news-content');
  const headers = rows[0];
  const newsRows = rows.slice(1).filter(r => r[headers.indexOf('Status View')]?.toLowerCase() === 'publish');

  container.innerHTML = '';
  newsRows.forEach(row => {
    const get = key => row[headers.indexOf(key)] || '';
    const title = get('Judul');
    const label = get('Label');
    const img = get('Gambar');
    const body = get('Body');
    const slug = get('Slug + PermaLink');
    const time = get('Tgl/Jam');

    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `
      <h2><a href="?berita=${slug}">${title}</a></h2>
      <small>${time} | <b>${label}</b></small>
      <img src="${img}" alt="${title}" style="max-width:100%;"/>
      <p>${body.substring(0, 150)}...</p>
    `;
    container.appendChild(div);
  });
}

// Load detail view if slug in URL
async function loadDetailIfSlug() {
  const params = new URLSearchParams(window.location.search);
  const slugParam = params.get('berita');
  if (!slugParam) return;

  const rows = await fetchSheet('Live Website');
  const headers = rows[0];
  const match = rows.find(r => r[headers.indexOf('Slug + PermaLink')] === slugParam);
  if (!match) return;

  const get = key => match[headers.indexOf(key)] || '';
  const title = get('Judul');
  const label = get('Label');
  const img = get('Gambar');
  const body = get('Body');
  const time = get('Tgl/Jam');

  const container = document.getElementById('news-content');
  container.innerHTML = `
    <article>
      <h1>${title}</h1>
      <small>${time} | <b>${label}</b></small>
      <img src="${img}" alt="${title}" style="max-width:100%;"/>
      <div>${body}</div>
    </article>
  `;

  document.title = title;
}

(async () => {
  await loadConfig();
  await loadMenu();
  await loadSidebars();
  const hasSlug = new URLSearchParams(window.location.search).has('berita');
  if (hasSlug) {
    await loadDetailIfSlug();
  } else {
    await loadNews();
  }
})();
</script>
</body>
</html>
